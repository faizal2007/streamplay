<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Stream Client (Demo)</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      #stream { border: 1px solid #ddd; width: 1280px; height: 720px; background: #000; }
      #controls { margin-bottom: 12px; }
    </style>
  </head>
  <body>
    <h2>Web Streamer Demo</h2>
    <div id="controls">
      <input id="url" placeholder="https://example.com" size="60" />
      <button id="start">Start Session</button>
      <span id="session">No session</span>
      <a href="/bench" style="margin-left:20px">Run Benchmark</a>
      <a href="/bench/history" style="margin-left:8px">Benchmark History</a>
    </div>
    <div>
      <img id="stream" alt="stream" />
    </div>

    <script src="https://cdn.socket.io/4.7.1/socket.io.min.js"></script>
    <script>
      const startBtn = document.getElementById('start');
      const urlInput = document.getElementById('url');
      const sessionSpan = document.getElementById('session');
      const img = document.getElementById('stream');

      let socket;
      let sessionId;

      // Connect as a client (not worker)
      function connectSocket() {
        socket = io({ query: { role: 'client' } });

        socket.on('connect', () => {
          console.log('connected to server', socket.id);
        });

        socket.on('joined', (d) => {
          console.log('joined', d);
        });

        socket.on('frame', (payload) => {
          if (payload.session_id !== sessionId) return;
          img.src = 'data:image/png;base64,' + payload.data;
        });
      }

      connectSocket();

      startBtn.onclick = async () => {
        const url = urlInput.value.trim();
        if (!url) { alert('enter a url'); return; }
        const resp = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await resp.json();
        sessionId = data.session_id;
        sessionSpan.textContent = 'Session: ' + sessionId;

        // Join room to receive frames
        socket.emit('join', { session_id: sessionId });
      };
    </script>
  </body>
</html>